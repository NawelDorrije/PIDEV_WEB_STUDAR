{% extends 'base.html.twig' %}

{% block title %}
    Meubles à vendre
{% endblock %}

{% block body %}
<!-- Styles inchangés -->
<style>
    .section-heading {
        text-align: center;
        margin-bottom: 60px;
    }

    .section-heading h6 {
        color: #f39c12;
        font-size: 1.2rem;
        letter-spacing: 2px;
        text-transform: uppercase;
    }

    .section-heading h2 {
        color: #333;
        font-size: 2.5rem;
        font-weight: 700;
    }

    .alert {
        border-radius: 20px;
        background: rgba(255, 255, 255, 0.9);
    }

    .card {
        border: none;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease;
    }

    .card:hover {
        transform: translateY(-5px);
    }

    .card-img-top {
        height: 200px;
        object-fit: cover;
        border-top-left-radius: 10px;
        border-top-right-radius: 10px;
    }

    .card-body {
        padding: 20px;
    }

    .card-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 10px;
    }

    .card-text {
        font-size: 0.9rem;
        color: #7f8c8d;
        margin-bottom: 15px;
    }

    .price {
        font-size: 1.1rem;
        font-weight: 700;
        color: #e67e22;
        margin-bottom: 15px;
    }

    .btn-container {
        display: flex;
        justify-content: center;
        gap: 10px;
    }

    .btn-modern {
        background: #f39c12;
        color: #fff;
        border: none;
        border-radius: 50px;
        padding: 10px 20px;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .btn-modern:hover {
        background: #e67e22;
        transform: scale(1.05);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .btn-detail {
        background: #2c3e50;
    }

    .btn-detail:hover {
        background: #34495e;
    }

    .modal {
        z-index: 1050 !important;
    }

    .modal-backdrop {
        z-index: 1040 !important;
        background-color: rgba(0, 0, 0, 0.3) !important;
    }

    .modal-dialog {
        max-width: 700px;
        z-index: 1051 !important;
    }

    .modal-content {
        border-radius: 15px;
        background: #fff;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        border: none;
        position: relative;
        z-index: 1052 !important;
    }

    .modal-header {
        border-bottom: none;
        background: #f39c12;
        color: #fff;
        border-top-left-radius: 15px;
        border-top-right-radius: 15px;
        padding: 15px 20px;
    }

    .modal-header .btn-close {
        filter: invert(1);
        z-index: 1053 !important;
    }

    .modal-body {
        padding: 30px;
        display: flex;
        flex-direction: row;
        align-items: stretch;
        z-index: 1052 !important;
    }

    .modal-image {
        flex: 1;
        margin-right: 20px;
    }

    .modal-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 10px;
    }

    .modal-details {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }

    .modal-details h4 {
        font-size: 1.5rem;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 10px;
    }

    .modal-details .info-table ul {
        list-style: none;
        padding: 0;
        margin-bottom: 20px;
    }

    .modal-details .info-table li {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #eee;
        font-size: 0.95rem;
        color: #333;
    }

    .modal-details .info-table span {
        font-weight: bold;
        color: #e67e22;
    }

    .modal-details .description {
        font-size: 0.9rem;
        color: #7f8c8d;
        margin-bottom: 20px;
    }
</style>

<div class="section meubles-a-vendre">
    <div class="container" style="position: relative; z-index: 1;">
        <div class="row">
            <div class="col-lg-12">
                <div class="section-heading">
                    <h6>| Meubles à vendre</h6>
                </div>
            </div>
        </div>

        <!-- Messages flash -->
        <div class="row">
            <div class="col-lg-12">
                {% for message in app.flashes('success') %}
                    <div class="alert alert-success d-flex align-items-center" role="alert" style="margin-bottom: 25px;">
                        <svg class="bi flex-shrink-0 me-2" width="24" height="24" role="img" aria-label="Succès :">
                            <use xlink:href="#check-circle-fill"/>
                        </svg>
                        <div>{{ message }}</div>
                    </div>
                {% endfor %}
                {% for message in app.flashes('error') %}
                    <div class="alert alert-danger d-flex align-items-center" role="alert" style="margin-bottom: 25px;">
                        <svg class="bi flex-shrink-0 me-2" width="24" height="24" role="img" aria-label="Erreur :">
                            <use xlink:href="#exclamation-triangle-fill"/>
                        </svg>
                        <div>{{ message }}</div>
                    </div>
                {% endfor %}
            </div>
        </div>

        <!-- Liste des meubles -->
        <div class="row">
            {% if meubles|length > 0 %}
                {% for meuble in meubles %}
                    <div class="col-lg-4 col-md-6 mb-5">
                        <div class="card">
                            <img src="{% if meuble.image %}{{ asset('images/' ~ meuble.image) }}{% else %}{{ asset('images/downloadImage.png') }}{% endif %}" 
                                 class="card-img-top" 
                                 alt="{{ meuble.nom }}">
                            <div class="card-body">
                                <h5 class="card-title">{{ meuble.nom }}</h5>
                                <p class="card-text">{{ meuble.description|length > 80 ? meuble.description|slice(0, 80) ~ '...' : meuble.description }}</p>
                                <p class="price">{{ meuble.prix }} TND</p>
                                <div class="btn-container">
                                    <form action="{{ path('app_gestion_meubles_ajouter_panier', {'id': meuble.id}) }}" method="POST" class="add-to-cart-form">
                                        <input type="hidden" name="_token" value="{{ csrf_token('add_to_cart_' ~ meuble.id) }}">
                                        <button type="submit" class="btn-modern add-to-cart-btn">
                                            <i class="fa fa-shopping-cart"></i> Ajouter
                                        </button>
                                    </form>
                                    <button type="button" class="btn-modern btn-detail" data-bs-toggle="modal" data-bs-target="#meubleModal{{ meuble.id }}">
                                        <i class="fa fa-eye"></i> Détail
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Modal -->
                        <div class="modal fade" id="meubleModal{{ meuble.id }}" tabindex="-1" aria-labelledby="meubleModalLabel{{ meuble.id }}" aria-hidden="true">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="meubleModalLabel{{ meuble.id }}">{{ meuble.nom }}</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <div class="modal-image">
                                            <img src="{% if meuble.image %}{{ asset('images/' ~ meuble.image) }}{% else %}{{ asset('images/downloadImage.png') }}{% endif %}" 
                                                 alt="{{ meuble.nom }}">
                                        </div>
                                        <div class="modal-details">
                                            <div>
                                                <h4>Détails du meuble</h4>
                                                <div class="info-table">
                                                    <ul>
                                                        <li>Prix <span>{{ meuble.prix }} TND</span></li>
                                                        <li>Statut <span>{{ meuble.statut|capitalize }}</span></li>
                                                        <li>Vendeur <span>{{ meuble.cinVendeur }}</span></li>
                                                    </ul>
                                                </div>
                                                <p class="description">{{ meuble.description }}</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="col-lg-12">
                    <div class="alert alert-info text-center" role="alert" style="font-size: 1.2rem; padding: 25px;">
                        Aucun meuble disponible actuellement. Revenez pour découvrir nos nouveautés !
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- SVG pour les messages flash -->
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
    <symbol id="check-circle-fill" fill="currentColor" viewBox="0 0 16 16">
        <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
    </symbol>
    <symbol id="exclamation-triangle-fill" fill="currentColor" viewBox="0 0 16 16">
        <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
    </symbol>
</svg>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        $('.add-to-cart-form').on('submit', function(e) {
            e.preventDefault();
            
            const $form = $(this);
            const $button = $form.find('.add-to-cart-btn');
            $button.prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> Ajout...');

            $.ajax({
                url: $form.attr('action'),
                method: 'POST',
                data: $form.serialize(),
                success: function(response) {
                    if (response.warning) {
                        alert(response.warning);
                        $button.html('<i class="fa fa-shopping-cart"></i> Ajouter').prop('disabled', false);
                    } else {
                        alert(response.message);
                        if (response.redirect) {
                            window.location.href = response.redirect; // Recharge la page
                        }
                        $button.html('<i class="fa fa-shopping-cart"></i> Ajouter').prop('disabled', false);
                    }
                },
                error: function(xhr) {
                    const error = xhr.responseJSON ? xhr.responseJSON.error : 'Une erreur est survenue';
                    alert('Erreur: ' + error);
                    $button.html('<i class="fa fa-shopping-cart"></i> Ajouter').prop('disabled', false);
                }
            });
        });
    });
</script>
{% endblock %}