{% extends 'base.html.twig' %}

{% block title %}Statistiques - Admin{% endblock %}

{% block body %}
<style>
    /* Général */
    .stats-container {
        max-width: 1200px;
        margin: 3rem auto;
        padding: 0 1.5rem;
        font-family: 'Inter', sans-serif;
    }
.subtitle {
    font-size: 1rem;
    color: #64748b;
    text-align: center;
    margin-bottom: 2rem;
}
    h1 {
        font-size: 2.2rem;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 2rem;
        text-align: center;
        background: linear-gradient(to right, #4f46e5, #3b82f6);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    

    /* Filtres */
    .filters-container {
        display: flex;
        justify-content: center;
        gap: 1.5rem;
        margin-bottom: 2rem;
        flex-wrap: wrap;
        background: #f8fafc;
        padding: 1rem;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }

    .filter-select {
        padding: 0.75rem 1rem;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        font-size: 0.95rem;
        color: #1e293b;
        background: #fff;
        width: 220px;
        transition: all 0.3s ease;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%236b7280'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 0.75rem center;
        background-size: 1.2rem;
    }

    .filter-select:focus {
        outline: none;
        border-color: #4f46e5;
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
    }

    /* Cartes KPI */
    .kpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2.5rem;
    }

    .kpi-card {
        background: linear-gradient(135deg, #ffffff, #f8fafc);
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        text-align: center;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .kpi-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 4px;
        background: linear-gradient(to right, #4f46e5, #3b82f6);
        opacity: 0.8;
    }

    .kpi-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    }

    .kpi-card i {
        font-size: 2rem;
        margin-bottom: 0.75rem;
        display: block;
    }

    .kpi-card.meubles i { color: #4f46e5; }
    .kpi-card.ca i { color: #10b981; }
    .kpi-card.top-vendeur i { color: #f97316; }
    .kpi-card.commandes i { color: #3b82f6; }

    .kpi-card h3 {
        font-size: 1rem;
        font-weight: 600;
        color: #64748b;
        margin-bottom: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .kpi-card .value {
        font-size: 1.8rem;
        font-weight: 700;
        color: #1e293b;
        line-height: 1.2;
    }

    .kpi-card .value.ca::after {
        content: ' TND';
        font-size: 1.2rem;
        color: #10b981;
    }

    .kpi-card .value small {
        font-size: 0.85rem;
        color: #64748b;
        display: block;
        margin-top: 0.5 grem;
    }

    /* Style spécifique pour la carte Commandes */
    .kpi-card.commandes .value {
        font-size: 1rem;
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.5rem;
        text-align: left;
    }

    .kpi-card.commandes .status-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem;
        border-radius: 8px;
        background: #f1f5f9;
        font-size: 0.9rem;
        color: #1e293b;
        transition: background 0.3s ease;
    }

    .kpi-card.commandes .status-item:hover {
        background: #e2e8f0;
    }

    .kpi-card.commandes .status-item.paye span { color: #10b981; }
    .kpi-card.commandes .status-item.livree span { color: #3b82f6; }
    .kpi-card.commandes .status-item.attente span { color: #f97316; }
    .kpi-card.commandes .status-item.annulee span { color: #ef4444; }

    /* Graphiques */
    .chart-container {
        background: #fff;
        border-radius: 12px;
        padding: 2rem;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        margin-bottom: 2.5rem;
        transition: transform 0.3s ease;
    }

    .chart-container:hover {
        transform: translateY(-5px);
    }

    .chart-container h2 {
        font-size: 1.5rem;
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .chart-container h2 i {
        color: #4f46e5;
        font-size: 1.2rem;
    }

    .chart-container canvas {
        max-width: 100%;
    }

    /* Calendrier */
    #calendar {
        background: #fff;
        border-radius: 12px;
        padding: 2rem;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        margin-bottom: 2.5rem;
    }

    .fc-daygrid-day-number {
        font-size: 1rem;
        color: #1e293b;
    }

    .fc-event {
        border: none !important;
        color: #fff !important;
        font-size: 0.9rem;
        padding: 4px 8px;
        border-radius: 6px;
        background: #4f46e5 !important;
        transition: background 0.3s ease;
    }

    .fc-event:hover {
        background: #3b82f6 !important;
    }

    .fc .fc-daygrid-day-top {
        padding: 0.5rem;
    }

    /* Responsive */
    @media (max-width: 1024px) {
        .kpi-grid {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }
    }

    @media (max-width: 768px) {
        .stats-container {
            padding: 0 1rem;
        }

        h1 {
            font-size: 1.8rem;
        }

        .filters-container {
            flex-direction: column;
            align-items: center;
        }

        .filter-select {
            width: 100%;
        }

        .kpi-grid {
            grid-template-columns: 1fr;
        }

        .nav-buttons {
            flex-direction: column;
            align-items: center;
        }

        .chart-container h2 {
            font-size: 1.3rem;
        }

        .kpi-card.commandes .value {
            grid-template-columns: 1fr;
            gap: 0.75rem;
        }
    }

    @media (max-width: 480px) {
        .kpi-card {
            padding: 1.25rem;
        }

        .kpi-card .value {
            font-size: 1.6rem;
        }

        .chart-container {
            padding: 1.25rem;
        }

        .kpi-card.commandes .status-item {
            font-size: 0.85rem;
            padding: 0.4rem;
        }
    }
</style>

<div class="stats-container">
    <h1>Tableau de Bord Administrateur</h1>
<p class="subtitle">Statistiques et gestion des meubles</p>
    <!-- Navigation -->
    <div class="nav-buttons">
        <a href="{{ path('app_gestion_meubles_meuble_admin') }}" class="nav-button" title="Consulter les meubles">
            <i class="bi bi-tag"></i>
            <span class="nav-text">Meubles</span>
        </a>
        <a href="{{ path('app_gestion_meubles_commandes_admin') }}" class="nav-button" title="Consulter les commandes">
            <i class="bi bi-cart"></i>
            <span class="nav-text">Commandes</span>
        </a>
        <a href="{{ path('app_gestion_meubles_statistiques') }}" class="nav-button active" title="Voir les statistiques">
            <i class="bi bi-bar-chart"></i>
            <span class="nav-text">Statistiques</span>
        </a>
    </div>

    <!-- Filtres -->
    <div class="filters-container">
        <select class="filter-select" id="filtre-statut" onchange="applyFilters()">
            <option value="" {% if filtreStatut == '' %}selected{% endif %}>Tous les statuts</option>
            <option value="EN_ATTENTE" {% if filtreStatut == 'EN_ATTENTE' %}selected{% endif %}>En attente</option>
            <option value="PAYÉE" {% if filtreStatut == 'PAYÉE' %}selected{% endif %}>Payée</option>
            <option value="LIVRÉE" {% if filtreStatut == 'LIVRÉE' %}selected{% endif %}>Livrée</option>
            <option value="ANNULEE" {% if filtreStatut == 'ANNULEE' %}selected{% endif %}>Annulée</option>
        </select>
        <select class="filter-select" id="filtre-periode" onchange="applyFilters()">
            <option value="all" {% if filtrePeriode == 'all' %}selected{% endif %}>Toutes périodes</option>
            <option value="month" {% if filtrePeriode == 'month' %}selected{% endif %}>Mois courant</option>
            <option value="year" {% if filtrePeriode == 'year' %}selected{% endif %}>Année courante</option>
        </select>
    </div>

    <!-- Cartes KPI -->
    <div class="kpi-grid">
        <div class="kpi-card meubles">
            <i class="bi bi-tag"></i>
            <h3>Total Meubles</h3>
            <div class="value">{{ nombreMeubles }}</div>
            <small>En stock actuellement</small>
        </div>
        <div class="kpi-card ca">
            <i class="bi bi-currency-dollar"></i>
            <h3>Chiffre d'Affaires</h3>
            <div class="value ca">{{ chiffreAffaires|number_format(2, ',', ' ') }}</div>
            <small>Période sélectionnée</small>
        </div>
        <div class="kpi-card top-vendeur">
            <i class="bi bi-person-check"></i>
            <h3>Top Vendeur</h3>
            <div class="value">
                {% if topVendeur %}
                    {{ topVendeur.nom }} {{ topVendeur.prenom }}
                    <small>{{ topVendeur.totalVentes|number_format(2, ',', ' ') }} TND</small>
                {% else %}
                    Aucun
                {% endif %}
            </div>
        </div>
        <div class="kpi-card commandes">
            <i class="bi bi-cart"></i>
            <h3>Commandes</h3>
            <div class="value">
                <div class="status-item paye">
                    Payées: <span>{{ commandesParStatut['PAYÉE']|default(0) }}</span>
                </div>
                <div class="status-item livree">
                    Livrées: <span>{{ commandesParStatut['LIVRÉE']|default(0) }}</span>
                </div>
                <div class="status-item attente">
                    En attente: <span>{{ commandesParStatut['EN_ATTENTE']|default(0) }}</span>
                </div>
                <div class="status-item annulee">
                    Annulées: <span>{{ commandesParStatut['ANNULEE']|default(0) }}</span>
                </div>
            </div>
        </div>
    </div>

<!-- Graphiques -->
<div class="chart-container">
    <h2><i class="bi bi-graph-up"></i> Chiffre d'Affaires par Mois</h2>
    {{ render_chart(caChart, {'class': 'chart-canvas'}) }}
</div>
<div class="chart-container">
    <h2><i class="bi bi-pie-chart"></i> Répartition des Commandes par Statut</h2>
    {{ render_chart(statutChart, {'class': 'chart-canvas'}) }}
</div>

    <!-- Calendrier -->
    <div id="calendar"></div>
</div>

{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Appliquer les filtres
            window.applyFilters = function() {
                const statut = document.getElementById('filtre-statut').value;
                const periode = document.getElementById('filtre-periode').value;
                window.location.href = '{{ path('app_gestion_meubles_statistiques') }}?statut=' + encodeURIComponent(statut) + '&periode=' + encodeURIComponent(periode);
            };

            // Initialiser le calendrier
            const calendarEl = document.getElementById('calendar');
            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'fr',
                height: 'auto',
                events: {{ calendarEvents|json_encode|raw }},
                eventMouseEnter: function(info) {
                    info.el.style.cursor = 'pointer';
                    const tooltip = document.createElement('div');
                    tooltip.className = 'tooltip';
                    tooltip.innerHTML = info.event.title;
                    tooltip.style.position = 'absolute';
                    tooltip.style.background = '#1e293b';
                    tooltip.style.color = '#fff';
                    tooltip.style.padding = '8px 12px';
                    tooltip.style.borderRadius = '6px';
                    tooltip.style.zIndex = '1000';
                    tooltip.style.fontSize = '0.85rem';
                    document.body.appendChild(tooltip);

                    const rect = info.el.getBoundingClientRect();
                    tooltip.style.left = rect.left + window.scrollX + 'px';
                    tooltip.style.top = rect.top + window.scrollY - 40 + 'px';

                    info.el.addEventListener('mouseleave', () => {
                        tooltip.remove();
                    });
                },
                eventClick: function(info) {
                    alert('Événement : ' + info.event.title);
                }
            });
            calendar.render();

            // Animation des cartes KPI
            const kpiCards = document.querySelectorAll('.kpi-card');
            kpiCards.forEach((card, index) => {
                card.style.animationDelay = `${index * 0.1}s`;
                card.classList.add('animate__animated', 'animate__fadeInUp');
            });
        });
    </script>
    <style>
        /* Animation pour les tooltips */
        .tooltip {
            opacity: 0;
            animation: fadeInTooltip 0.3s ease forwards;
        }

        @keyframes fadeInTooltip {
            to { opacity: 1; }
        }

        /* Animation pour les cartes */
        .animate__animated.animate__fadeInUp {
            animation: fadeInUp 0.6s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
{% endblock %}