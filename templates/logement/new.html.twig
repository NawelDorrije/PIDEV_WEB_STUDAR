{% extends 'base.html.twig' %}

{% block title %}New Logement{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        let map;
        let marker;

        function initMap() {
            map = L.map('map').setView([36.8065, 10.1815], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            marker = L.marker([36.8065, 10.1815], {
                draggable: true
            }).addTo(map);

            map.on('click', function(e) {
                marker.setLatLng(e.latlng);
                updateFields(e.latlng);
            });

            marker.on('dragend', function(e) {
                updateFields(marker.getLatLng());
            });

            updateFields(marker.getLatLng());
        }

        async function updateFields(latlng) {
            const latField = document.getElementById('latitude');
            const lonField = document.getElementById('longitude');
            const addressField = document.querySelector('input[name="logement[address]"]');

            if (!latField || !lonField || !addressField) {
                console.error('One or more input fields not found in DOM:', {
                    latField: !!latField,
                    lonField: !!lonField,
                    addressField: !!addressField
                });
                return;
            }

            latField.value = latlng.lat;
            lonField.value = latlng.lng;

            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${latlng.lat}&lon=${latlng.lng}&format=json&addressdetails=1`, {
                    headers: {
                        'User-Agent': 'MySymfonyApp/1.0 (contact@myapp.com)'
                    }
                });
                const data = await response.json();
                console.log('Nominatim API Response:', data);

                if (data && data.display_name) {
                    addressField.value = data.display_name;
                } else {
                    addressField.value = 'Address not found';
                    console.warn('No display_name in API response');
                }
            } catch (error) {
                console.error('Error fetching address:', error);
                addressField.value = 'Error retrieving address';
            }
        }

        document.addEventListener('DOMContentLoaded', initMap);
    </script>
{% endblock %}

{% block body %}
    <div class="contact-page section">
        <div class="container">
            <div class="row row-page">
                <div class="col-lg-12">
                    <h1 class="center">Create New Logement</h1>

                </div>
                <div class="col-lg-12 right-column">
                 
                  
                    {{ form_start(form, {'attr': {'id': 'contact-form'}}) }}
                    
                    <div class="row">
                      
                        <div class="col-lg-6">
                            <div class="col-lg-12">
                                {{ form_widget(form.nbrChambre, {
                                    'attr': {
                                        'placeholder': 'Number of Rooms',
                                        'class': 'form-control' ~ (form.nbrChambre.vars.errors|length > 0 ? ' is-invalid' : ''),
                                        'required': 'required'
                                    }
                                }) }}
                                {{ form_errors(form.nbrChambre) }}
                            </div>

                            <div class="col-lg-12">
                                {{ form_widget(form.prix, {
                                    'attr': {
                                        'placeholder': 'Price (€)',
                                        'class': 'form-control' ~ (form.prix.vars.errors|length > 0 ? ' is-invalid' : ''),
                                        'required': 'required'
                                    }
                                }) }}
                                {{ form_errors(form.prix) }}
                            </div>

                            <div class="col-lg-12">
                                {{ form_widget(form.type, {
                                    'attr': {
                                        'placeholder': 'Property Type',
                                        'class': 'form-control' ~ (form.type.vars.errors|length > 0 ? ' is-invalid' : ''),
                                        'required': 'required'
                                    }
                                }) }}
                                {{ form_errors(form.type) }}
                            </div>
                        </div>

                        <div class="col-lg-6">
                            <div class="col-lg-12">
                                {{ form_widget(form.address, {
                                    'attr': {
                                        'placeholder': 'Address (auto-filled)',
                                        'class': 'form-control',
                                        'id': 'logement_address'
                                    }
                                }) }}
                            </div>

                            <div class="col-lg-12">
                                {{ form_widget(form.latitude, {
                                    'attr': {
                                        'id': 'latitude',
                                        'class': 'd-none'
                                    }
                                }) }}
                            </div>

                            <div class="col-lg-12">
                                {{ form_widget(form.longitude, {
                                    'attr': {
                                        'id': 'longitude',
                                        'class': 'd-none'
                                    }
                                }) }}
                            </div>
                        </div>

                        <div class="col-lg-12">
                            {{ form_widget(form.description, {
                                'attr': {
                                    'placeholder': 'Description',
                                    'class': 'form-control' ~ (form.description.vars.errors|length > 0 ? ' is-invalid' : ''),
                                    'rows': 5,
                                    'required': 'required'
                                }
                            }) }}
                            {{ form_errors(form.description) }}
                        </div>

                        <div id="map" style="height: 400px; width: 100%; margin: 20px 0; border-radius: 8px;"></div>

                        <div class="col-lg-12" style="margin-top: 20px;">
                            <button type="submit" class="orange-button">{{ button_label|default('Save') }}</button>
                        </div>
                    </div>
                    {{ form_end(form) }}

                    <div class="center" style="margin-top: 20px;">
                        <a href="{{ path('app_logement_index') }}" class="btn btn-secondary">
                            <i class="fa fa-arrow-left"></i> Back to List
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}